[[extend 'layout.html']]

<style>
  [v-cloak] {
    display: none;
  }

  .box-container {
    display: inline-block;
    vertical-align: top;
  }

  .box {
    max-width: 100%; /* Allow boxes to shrink to content width */
  }

  @media screen and (max-width: 1000px) {
    .column.is-3 {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  }
  
  #map {
    width: 35%;
  }
  
  ul {
    list-style-type: none; /* Remove default bullet points */
    padding-left: 0; /* Remove default padding */
  }

  ul ul {
    padding-left: 0; /* Remove indent for nested list */
  }

  ul li {
    margin-bottom: 10px; /* Add some spacing between list items */
  }

  .species-button {
    margin-bottom: 5px;
    display: inline-block;
    width: 100%;
    text-align: left;
    padding: 0.5em 1em;
  }

  .date-list {
    display: flex;
    flex-wrap: wrap; /* Allow wrapping */
    gap: 10px; /* Space between buttons */
    margin-top: 10px;
  }

  .date-button {
    padding: 0.3em 0.8em;
    font-size: 0.9em;
    flex: 0 1 150px; /* Grow to fill available space, but not exceed 150px */
    text-align: center; /* Center text in button */
    margin: 5px; /* Additional margin for spacing */
    box-sizing: border-box; /* Include padding and border in element's width and height */
  }

  .is-hidden {
    display: none;
  }
</style>

<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>
</head>

<div class="section" id="statistics-app" v-cloak>
  <h1 class="title"><i class="fa-solid fa-cube"></i> User Statistics Page</h1>
  <p>The user statistics pages allows the user to search birds and either search by recent or first sightings. Clicking on the species will direct you to dates found. Clicking on those dates will direct the map to the location of where it was found recently. </p>
  <div class="field is-grouped">
    <div class="control is-three-quarters">
      <input class="input" type="text" v-model="query" placeholder="Search common names">
    </div>
    <div class="field">
      <div class="control">
        <div class="select">
          <select id="statistics-options" @change="updateSearchOption">
            <option value="option1">Recently seen</option>
            <option value="option2">First seen</option>
          </select>
        </div>
      </div>
    </div>
    <div class="control">
      <button class="button is-primary" @click="search">Search</button>
    </div>
  </div>
  <div>
    <div id="map" style="height: 300px"></div>
  </div>
  <div class="columns is-multiline">
    <div class="column is-one-third" v-for="(name, index) in common_names" :key="name.COMMON_NAME">
      <ul>
        <li>
          <!-- Main button for the species name with toggle functionality -->
          <button class="button is-link is-light species-button" @click="toggleObservationDates(index)">
            {{ name.COMMON_NAME }}
          </button>
          <ul :class="{'is-hidden': !name.isExpanded}" class="date-list">
            <li v-for="date in name.observation_dates" :key="date.OBSERVATION_DATE">
              <!-- Secondary button for the observation dates -->
              <button class="button is-small is-info is-outlined date-button" @click="moveMapToObservation(name, date)">
                {{ date.OBSERVATION_DATE }}
              </button>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</div>

[[block page_scripts]]
<script>
  let load_user_statistics_url = "[[=XML(load_user_statistics_url)]]";
  let search_url = "[[=XML(search_url)]]";
  let observation_dates_url = "[[=XML(observation_dates_url)]]"; 
</script>
<script src="js/statistics.js"></script>
<script src="js/leaflet-heat.js"></script>
<script src="js/convex-hull.js"></script>
<script src="js/map.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const map = L.map('map').setView([37.06096445677006, -84.63335595604734], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const userLocation = [position.coords.latitude, position.coords.longitude];
        map.setView(userLocation, 13);
        L.marker(userLocation).addTo(map)
          .bindPopup('You are here')
          .openPopup();
      });
    }

    window.map = map; // Make map accessible globally
  });

  // Adding the toggle functionality to Vue.js data
  new Vue({
    el: '#statistics-app',
    data: {
      query: '',
      common_names: [
        { COMMON_NAME: 'White-crowned Sparrow', observation_dates: [
          { OBSERVATION_DATE: '2021-02-01' },
          { OBSERVATION_DATE: '2021-02-02' },
          { OBSERVATION_DATE: '2021-02-03' },
          { OBSERVATION_DATE: '2021-02-04' },
          { OBSERVATION_DATE: '2021-02-05' },
          { OBSERVATION_DATE: '2021-02-06' },
          { OBSERVATION_DATE: '2021-02-07' },
          { OBSERVATION_DATE: '2021-02-08' },
          { OBSERVATION_DATE: '2021-02-09' },
        ], isExpanded: false },
        // Add your other bird data here with `isExpanded` property for toggle functionality
      ]
    },
    methods: {
      toggleObservationDates(index) {
        this.common_names[index].isExpanded = !this.common_names[index].isExpanded;
      },
      moveMapToObservation(name, date) {
        // Logic to move the map to the observation location
        alert(`Move map to the location of ${name.COMMON_NAME} observed on ${date.OBSERVATION_DATE}`);
      }
    }
  });
</script>
[[end]]
